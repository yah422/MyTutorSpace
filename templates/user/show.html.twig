{% extends 'base.html.twig' %}

{% block title %}Profil{% endblock %}

{% block body %}
<div class="min-h-screen flex items-center justify-center bg-[#1B4255] flex-col gap-7.5">
        <!-- Flash Messages -->
        {# <div class="
                p-4 rounded-lg mb-4 font-bold
                text-black
                {% if app.flashes is not empty %}
                        {% for label, messages in app.flashes %}
                        {% if label == 'success' %} bg-teal-500 border-teal-700
                        {% elseif label == 'warning' %} bg-yellow-400 border-yellow-600
                        {% elseif label == 'error' %} bg-red-500 border-red-700
                        {% endif %}
                        {% endfor %}
                {% endif %}
                fade-out
                ">
                {% for message in messages %}
                {{ message }}
                {% endfor %}
        </div> #}

        <div class="container mx-auto max-w-4xl p-6 rounded-lg shadow-lg bg-[#567C8D]">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                        <!-- Section gauche : Photo de profil -->
                        <div class="flex flex-col items-center">
                                <img src="{{ user.profilePicture 
                ? asset('uploads/avatars/' ~ user.profilePicture) 
                : asset('uploads/avatars/default-profile.png') }}"
                                        alt="Photo de profil de {{ user.prenom }} {{ user.nom }}"
                                        class="w-[200px] h-[200px] object-cover rounded-full shadow-md">
                                <h2 class="text-2xl md:text-3xl font-extrabold mt-4 text-center text-[#FFD700]">
                                        {{ user.prenom }} {{ user.nom }}
                                </h2>
                                {% if user.roles is defined and 'ROLE_TUTEUR' in user.roles %}
                                <span
                                        class="px-3 py-1 text-sm font-semibold bg-[#70F9D9] text-[#1B4255] rounded-full mt-2">
                                        Tuteur
                                </span>
                                {% endif %}
                        </div>

                        <!-- Section droite : Informations utilisateur -->
                        <div class="space-y-6">
                                <div class="space-y-4">
                                        <p class="text-gray-300 text-base md:text-lg">
                                                <span class="font-bold">Email :</span>
                                                {% if is_granted('ROLE_ADMIN') or app.user and app.user.id == user.id %}
                                                {{ user.email }}
                                                {% else %}
                                                <span class="italic">Information privée :</span>
                                                {% endif %}
                                        </p>
                                        <p class=" flex justify-start text-gray-300 text-base md:text-lg">
                                                <span class="font-bold">À propos :</span>
                                        </p>
                                        <p class=" flex justify-center text-gray-300 text-sm md:text-base">
                                                {{ user.aboutMe | default("Aucune information disponible.") }}
                                        </p>
                                        {# Vérifier les rôles avant d'afficher le taux horaire #}
                                        {% if not (is_granted('ROLE_PARENT') or is_granted('ROLE_ELEVE')) %}
                                        <div>
                                                <p class="text-gray-300 text-base md:text-lg">Taux horaire :</p>
                                                <p class="text-gray-300 font-medium">{{ user.hourlyRate }}€/h</p>
                                        </div>
                                        {% endif %}
                                </div>

                                <!-- Actions avec restrictions d'accès -->
                                <div class="space-y-3">
                                        {% if app.user and app.user.id == user.id %}
                                        <a href="{{ path('edit_user', { id: user.id }) }}"
                                                class="block w-full text-center py-2 text-sm md:text-base font-bold rounded bg-[#FFD700] text-[#1B4255] hover:bg-[#70F9D9] transition-colors duration-300">
                                                Modifier mon profil
                                        </a>
                                        <a href="{{ path('app_dashboard') }}"
                                                class="block w-full text-center py-2 text-sm md:text-base font-bold rounded bg-[#70F9D9] text-[#1B4255] hover:bg-[#FFD700] transition-colors duration-300">
                                                Mon tableau de bord
                                        </a>
                                        {% elseif app.user and 'ROLE_ADMIN' in app.user.roles %}
                                        <a href="{{ path('edit_user', { id: user.id }) }}"
                                                class="block w-full text-center py-2 text-sm md:text-base font-bold rounded bg-[#FFD700] text-[#1B4255] hover:bg-[#70F9D9] transition-colors duration-300">
                                                Modifier le profil (Admin)
                                        </a>
                                        {% endif %}
                                        <div class="flex flex-row justify-between space-x-[10px]">
                                                {% if app.user and app.user != user %}
                                                <a href="{{ path('new_message') }}"
                                                        class="block w-full text-center py-2 text-sm md:text-base font-bold rounded bg-[#70F9D9] text-[#1B4255] hover:bg-[#FFD700] transition-colors duration-300">
                                                        Contacter le tuteur
                                                </a>
                                                <button class="save-profile-btn" data-id="{{ user.id }}"
                                                        data-url="{{ path('app_save_profile', { id: user.id }) }}">
                                                        <img src="{{ asset('img/save.png') }}" alt="saveImage">
                                                </button>
                                                {% endif %}
                                        </div>
                                        {% if app.user and 'ROLE_ELEVE' and 'ROLE_PARENT' in app.user.roles %}
                                        <a href="{{ path('app_booking', { tuteur: user.id }) }}"
                                                class="block w-full text-center py-2 text-sm md:text-base font-bold rounded bg-[#FFD700] text-[#1B4255] hover:bg-[#70F9D9] transition-colors duration-300">
                                                Réserver une séance
                                        </a>
                                        {% endif %}
                                </div>
                        </div>
                </div>
        </div>

</div>
<script>
        document.querySelectorAll('.save-profile-btn').forEach(button => {
                button.addEventListener('click', () => {
                        const url = button.dataset.url;

                        fetch(url, {
                                method: 'POST',
                                headers: {
                                        'X-Requested-With': 'XMLHttpRequest',
                                        'Content-Type': 'application/json'
                                }
                        })
                                .then(response => response.json())
                                .then(data => {
                                        // Si la sauvegarde est réussie
                                        if (data.success) {
                                                // Changer l'image du bouton pour montrer qu'il a été sauvegardé
                                                const img = button.querySelector('img');
                                                img.src = "{{ asset('img/saved-icon.png') }}";  // Remplacez avec l'icône de "profil sauvegardé"
                                                img.alt = "Profil sauvegardé";

                                                // Sauvegarder l'état dans le localStorage pour persister après rafraîchissement
                                                localStorage.setItem('profileSaved_' + button.dataset.id, 'true');
                                        } else {
                                                // Afficher le message d'erreur si le profil est déjà sauvegardé
                                                alert(data.message);
                                        }
                                })
                                .catch(error => console.error('Erreur lors de la sauvegarde :', error));
                });
        });

        // Vérifier l'état de la sauvegarde après le chargement de la page
        document.querySelectorAll('.save-profile-btn').forEach(button => {
                const isSaved = localStorage.getItem('profileSaved_' + button.dataset.id);
                if (isSaved === 'true') {
                        const img = button.querySelector('img');
                        img.src = "{{ asset('img/saved-icon.png') }}";  // L'icône de profil sauvegardé
                        img.alt = "Profil sauvegardé";
                }
        });

</script>
{% endblock %}